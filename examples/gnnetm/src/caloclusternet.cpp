#include "caloclusternet.h"

array<gravnet_exponential_t, static_pow2(LUT_SIZE)> expLUT = { 0.99609375, 0.98046875, 0.9609375, 0.94140625, 0.921875, 0.90625, 0.88671875, 0.87109375, 0.8515625, 0.8359375, 0.8203125, 0.8046875, 0.7890625, 0.7734375, 0.7578125, 0.7421875, 0.73046875, 0.71484375, 0.703125, 0.6875, 0.67578125, 0.66015625, 0.6484375, 0.63671875, 0.625, 0.61328125, 0.6015625, 0.58984375, 0.578125, 0.56640625, 0.5546875, 0.54296875, 0.53515625, 0.5234375, 0.51171875, 0.50390625, 0.4921875, 0.484375, 0.47265625, 0.46484375, 0.45703125, 0.4453125, 0.4375, 0.4296875, 0.421875, 0.4140625, 0.40625, 0.3984375, 0.390625, 0.3828125, 0.375, 0.3671875, 0.359375, 0.3515625, 0.34765625, 0.33984375, 0.33203125, 0.328125, 0.3203125, 0.3125, 0.30859375, 0.30078125, 0.296875, 0.2890625, 0.28515625, 0.27734375, 0.2734375, 0.26953125, 0.26171875, 0.2578125, 0.25390625, 0.24609375, 0.2421875, 0.23828125, 0.234375, 0.23046875, 0.2265625, 0.21875, 0.21484375, 0.2109375, 0.20703125, 0.203125, 0.19921875, 0.1953125, 0.19140625, 0.1875, 0.18359375, 0.1796875, 0.17578125, 0.17578125, 0.171875, 0.16796875, 0.1640625, 0.16015625, 0.15625, 0.15625, 0.15234375, 0.1484375, 0.14453125, 0.14453125, 0.140625, 0.13671875, 0.1328125, 0.1328125, 0.12890625, 0.125, 0.125, 0.12109375, 0.12109375, 0.1171875, 0.11328125, 0.11328125, 0.109375, 0.109375, 0.10546875, 0.10546875, 0.1015625, 0.1015625, 0.09765625, 0.09765625, 0.09375, 0.09375, 0.08984375, 0.08984375, 0.0859375, 0.0859375, 0.08203125, 0.08203125, 0.08203125, 0.078125, 0.078125, 0.07421875, 0.07421875, 0.07421875, 0.0703125, 0.0703125, 0.06640625, 0.06640625, 0.06640625, 0.0625, 0.0625, 0.0625, 0.05859375, 0.05859375, 0.05859375, 0.05859375, 0.0546875, 0.0546875, 0.0546875, 0.05078125, 0.05078125, 0.05078125, 0.05078125, 0.046875, 0.046875, 0.046875, 0.046875, 0.04296875, 0.04296875, 0.04296875, 0.04296875, 0.04296875, 0.0390625, 0.0390625, 0.0390625, 0.0390625, 0.0390625, 0.03515625, 0.03515625, 0.03515625, 0.03515625, 0.03515625, 0.03125, 0.03125, 0.03125, 0.03125, 0.03125, 0.03125, 0.02734375, 0.02734375, 0.02734375, 0.02734375, 0.02734375, 0.02734375, 0.02734375, 0.0234375, 0.0234375, 0.0234375, 0.0234375, 0.0234375, 0.0234375, 0.0234375, 0.0234375, 0.01953125, 0.01953125, 0.01953125, 0.01953125, 0.01953125, 0.01953125, 0.01953125, 0.01953125, 0.01953125, 0.015625, 0.015625, 0.015625, 0.015625, 0.015625, 0.015625, 0.015625, 0.015625, 0.015625, 0.015625, 0.015625, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.01171875, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.0078125, 0.00390625, 0.00390625, 0.00390625, 0.00390625, 0.00390625, 0.00390625, 0.};

void caloclusternet(hls::stream<array<model_input_t,  MODEL_INPUT_WIDTH>>  inputStream[PAR],
                    hls::stream<array<model_output_t,  MODEL_OUTPUT_WIDTH>> outputStream[PAR],
                    hls::stream<bool> lastStream[PAR],
                    hls::stream<int> &numStream,
                    cps_beta_t betaThreshold,
                    cps_distance_t isolationThreshold) {
    #pragma HLS DATAFLOW disable_start_propagation
    #pragma HLS INTERFACE mode=axis port=inputStream
    #pragma HLS INTERFACE mode=axis port=outputStream 
    #pragma HLS INTERFACE mode=axis port=lastStream 
    #pragma HLS INTERFACE mode=axis port=numStream 
	#pragma HLS stable variable=betaThreshold
    #pragma HLS interface port=betaThreshold mode=ap_none
    #pragma HLS stable variable=isolationThreshold
    #pragma HLS interface port=isolationThreshold mode=ap_none

	caloclusternetv4<model_input_t,
				   dense_relu_t,
				   dense_weight_t,
				   dense_biases_t,
				   dense_accum_t,
				   first_dense_accum_t,
				   gravnet_relu_t,
				   gravnet_weight_t,
				   gravnet_biases_t,
				   gravnet_accum_t,
				   gravnet_coordinate_t,
				   gravnet_feature_t,
				   gravnet_distance_t,
				   gravnet_exponential_t,
				   gravnet_data_t,
				   model_output_t,
				   cps_beta_t,
				   cps_distance_t,
				   cps_identifier_t,
				   energy_weight_t,
				   energy_biases_t,
				   tpos_weight_t,
				   tpos_biases_t,
				   ccoords_weight_t,
				   ccoords_biases_t,
				   beta_weight_t,
				   beta_biases_t,
				   signal_weight_t,
				   signal_biases_t,
				   MODEL_INPUT_WIDTH,
				   DENSE_1_OUTPUT_WIDTH,
				   DENSE_2_OUTPUT_WIDTH,
				   DENSE_3_OUTPUT_WIDTH,
				   GRAVNET_1_OUTPUT_WIDTH,
				   DENSE_4_OUTPUT_WIDTH,
				   DENSE_5_OUTPUT_WIDTH,
				   DENSE_6_OUTPUT_WIDTH,
				   DENSE_7_OUTPUT_WIDTH,
				   DENSE_8_OUTPUT_WIDTH,
				   GRAVNET_2_OUTPUT_WIDTH,
				   DENSE_9_OUTPUT_WIDTH,
				   DENSE_10_OUTPUT_WIDTH,
				   DENSE_11_OUTPUT_WIDTH,
				   DENSE_SCALE_OUTPUT_WIDTH,
				   MODEL_OUTPUT_WIDTH,
				   GRAVNET_1_K,
				   GRAVNET_2_K,
				   N,
				   PAR,
				   II,
				   BETA_WIDTH,
				   ENERGY_WIDTH,
				   TPOS_WIDTH,
				   SIGNAL_WIDTH,
				   CCORDS_WIDTH,
				   BETA_OFFSET,
				   ENERGY_OFFSET,
				   LUT_SIZE>(inputStream,
				   			 outputStream,
				   			 lastStream,
				   			 numStream,
				   			 betaThreshold,
				   			 isolationThreshold,
							 dense1Weights,
							 dense1Biases,
							 dense2Weights,
							 dense2Biases,
							 dense3Weights,
							 dense3Biases,
							 dense4Weights,
							 dense4Biases,
							 dense5Weights,
							 dense5Biases,
							 dense6Weights,
							 dense6Biases,
							 dense7Weights,
							 dense7Biases,
							 dense8Weights,
							 dense8Biases,
							 dense9Weights,
							 dense9Biases,
							 dense10Weights,
							 dense10Biases,
							 dense11Weights,
							 dense11Biases,
							 denseScaleWeights,
							 denseScaleBiases,
							 tposWeights,
							 tposBiases,
							 ccordsWeights,
							 ccordsBiases,
							 betaWeights,
							 betaBiases,
							 energyWeights,
							 energyBiases,
							 signalWeights,
							 signalBiases,
							 expLUT);
}