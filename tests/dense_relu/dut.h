#ifndef DUT_H__
#define DUT_H__

#include <array>
#include "hls_math.h"
#include "hls_stream.h"

// Test parameters for integer dense layer
static const int II = 2;
static const int INPUT_WIDTH = 32;
static const int OUTPUT_WIDTH = 32;

typedef ap_fixed<8,3>  input_relu_t;
typedef ap_fixed<8,1>  weight_t;
typedef ap_fixed<8,1>  biases_t;
typedef ap_fixed<22,9> accum_t;
typedef ap_fixed<8,2>  output_relu_t;

static weight_t weights[INPUT_WIDTH * OUTPUT_WIDTH] = {0., 0., -0.2734375, 0.3046875, 0., 0., -0.1328125, 0.0859375, 0.3359375, 0., 0., -0.0859375, 0.140625, 0.2421875, -0.1171875, -0.0390625, 0.2265625, 0., 0.0234375, 0., 0., 0., -0.390625, -0.046875, 0.375, -0.1875, 0., 0.0078125, 0., 0., -0.328125, 0.203125, 0.9921875, 0.9921875, 0., 0.9921875, -0.2421875, 0.9921875, -0.0625, 0., 0., 0.078125, 0.1640625, 0., -0.8203125, 0.9921875, -0.09375, 0., 0., 0., 0.0703125, 0.03125, 0.015625, 0.1875, -0.203125, 0., 0., -0.578125, 0., -0.1328125, 0.4375, 0., 0., -0.140625, 0., 0., 0., 0.203125, 0., -0.109375, 0., 0.2265625, 0., -0.1875, 0., -0.28125, 0., 0., 0.2578125, 0.25, -0.2421875, 0.0078125, 0., 0.453125, -0.1875, 0., 0., 0.0234375, 0.203125, 0., 0.6640625, 0.0234375, 0., 0., -0.2421875, 0., 0., 0.03125, 0., -0.046875, 0., -0.03125, 0., -0.1953125, 0., -0.4453125, -0.25, 0., 0., 0., 0., 0., 0., 0.2734375, -0.1640625, 0., 0.625, 0., 0., -0.1171875, 0., -0.28125, 0.0625, -0.28125, 0.2734375, 0., -0.3203125, 0.3984375, 0.25, -0.3203125, -0.2109375, 0.2734375, -0.1875, -0.15625, 0.46875, 0., 0., 0.5, -0.0390625, 0.484375, 0., 0., 0., 0.2890625, 0.28125, 0., -0.15625, 0., 0., 0.296875, -0.390625, 0., 0., 0.3515625, 0.1171875, -0.609375, 0., 0.0625, 0., 0.328125, 0.0546875, 0., 0.1875, 0.109375, -0.09375, -0.2578125, -0.3046875, 0.21875, 0., 0.3203125, 0.1328125, 0., 0., 0., 0.40625, -0.3125, 0., 0., 0., 0., 0., 0., 0.2734375, 0., 0., -0.0859375, 0.4921875, 0.453125, 0.625, 0., 0.140625, 0., 0.140625, 0., -0.1640625, 0.0546875, 0.3359375, -0.140625, 0., -0.3828125, 0.375, 0.2109375, 0., 0., 0., 0., 0., 0., 0.375, -0.234375, 0., -0.3828125, 0.3203125, 0.3359375, -0.375, 0., -0.1015625, 0.2421875, 0., 0.1328125, 0.2734375, 0.15625, 0., 0.4765625, 0.515625, 0.1484375, 0., 0.359375, -0.0546875, 0.9921875, 0., 0.5234375, 0., 0.1796875, 0., -0.0859375, 0.125, 0.7421875, -0.2265625, 0., 0.375, 0., 0., 0., 0., -0.0703125, -0.3828125, 0., 0.5078125, 0.0546875, 0.140625, 0.0390625, 0., 0., 0.2578125, 0.140625, 0., 0.0390625, 0.40625, 0.1953125, 0.2109375, -0.2421875, 0., 0.359375, -0.1484375, 0.1875, -0.375, 0., 0.28125, -0.2109375, 0.15625, 0., 0., 0., 0., -0.21875, -0.25, 0.2109375, 0., 0., -0.3828125, 0., 0., 0., -0.3828125, -0.109375, 0.4375, 0.734375, 0.9921875, 0.9921875, 0.078125, 0.9921875, -0.375, 0.9921875, 0.078125, 0., -0.3359375, 0.1328125, 0., 0.1015625, -0.9921875, 0.9921875, 0.09375, 0.078125, 0., -0.9921875, -0.1171875, -0.140625, 0.1875, 0.0625, 0., 0., -0.2265625, -0.359375, -0.0390625, -0.015625, -0.2890625, -0.1484375, 0.46875, 0.03125, 0., -0.1953125, 0., 0., 0., -0.28125, 0., 0., -0.3671875, 0., 0.0546875, 0., -0.1875, 0., 0.375, 0., -0.1640625, 0., -0.1640625, 0.203125, -0.4140625, 0., 0.4921875, 0.15625, 0., 0., -0.0546875, 0., 0., -0.5625, 0.15625, 0.2109375, 0., -0.265625, 0., 0., 0., 0., 0.2578125, 0.2421875, -0.265625, 0., 0., 0., 0.015625, 0.015625, 0., 0.421875, 0.34375, 0., 0., 0.3671875, 0.296875, 0., 0.171875, 0., 0.109375, 0., 0., -0.3671875, 0.21875, 0., 0.2109375, -0.109375, 0., 0., 0.2890625, -0.34375, 0., -0.2109375, 0., -0.3828125, -0.2421875, 0., 0.1796875, 0.2578125, 0.578125, 0., 0.125, 0., -0.3515625, 0.2890625, -0.5, 0., 0.1875, -0.2890625, -0.1328125, 0.625, 0.265625, 0., 0., 0., -0.203125, 0., 0.203125, -0.3671875, 0.1484375, 0., 0., 0.203125, -0.0390625, 0., 0., 0., 0.1796875, 0.25, 0.0390625, -0.1015625, 0., -0.03125, 0., 0., 0., 0.484375, -0.046875, 0.40625, 0., -0.1484375, 0., 0.1875, -0.25, 0., -0.3984375, -0.0234375, 0., 0., 0., 0., -0.046875, 0., 0.1640625, 0., 0.3046875, 0.203125, 0., -0.25, 0.40625, 0., -0.0859375, 0., 0.15625, 0.21875, 0., 0., 0.203125, -0.1328125, 0.1015625, 0.1015625, 0.234375, 0.0859375, 0., -0.0390625, 0., 0., 0.3359375, 0., 0., 0., 0.4765625, -0.3046875, 0., 0.1171875, 0.3515625, -0.21875, 0., 0., -0.28125, 0., 0.515625, 0., 0., 0.3359375, 0., 0., 0.234375, 0., 0., 0., 0.3359375, -0.265625, -0.234375, -0.4296875, 0.4765625, 0., 0., 0.3125, -0.28125, -0.0546875, -0.3828125, 0., 0., -0.4765625, -0.3515625, 0.9453125, 0., 0.265625, -0.5859375, 0., 0., 0.359375, -0.5078125, 0., -0.109375, -0.3359375, 0., 0.578125, -0.9921875, -0.1484375, -0.328125, 0.46875, 0., -0.0625, 0., -0.125, 0., -0.875, -0.4453125, 0.09375, 0., 0.3984375, 0.8671875, -0.453125, 0., 0., -0.03125, 0., -0.2890625, 0., -0.03125, 0., 0., 0., 0., -0.0234375, 0., 0., -0.46875, 0., -0.0625, 0., -0.4140625, 0.34375, -0.4375, 0., 0., -0.5, -0.3515625, 0.0078125, 0., 0., -0.15625, -0.703125, 0.078125, 0., 0., 0., 0., 0., -0.25, 0.0390625, 0., 0.21875, 0.2734375, -0.265625, 0.1015625, 0., 0., 0., -0.8359375, 0., -0.9921875, -0.015625, 0., -0.0234375, 0., 0., 0., 0.3046875, 0., 0., 0., -0.125, -0.140625, -0.2734375, 0.546875, 0.2265625, -0.0625, -0.3984375, 0., 0., 0., -0.2890625, 0., -0.9921875, -0.390625, -0.3359375, 0., 0., 0.046875, 0., -0.2734375, -0.7265625, -0.640625, 0.3359375, 0., 0.6328125, 0., 0.296875, 0., 0.3359375, -0.1953125, -0.1953125, 0.2265625, 0., -0.1171875, 0., 0.375, 0.3515625, 0., 0., 0., 0., 0., 0., 0., -0.34375, 0.0078125, -0.1796875, 0.0703125, 0., -0.03125, 0.0234375, 0., 0.3515625, 0., -0.2734375, 0., 0., -0.234375, -0.421875, 0., 0., -0.1875, -0.390625, 0.21875, 0.375, 0., 0.1484375, 0.3515625, 0.75, 0., -0.1875, 0.6015625, 0.5, 0.25, 0.265625, -0.5546875, 0.8515625, -0.0546875, 0., -0.375, 0.2421875, 0.9921875, -0.2578125, -0.40625, -0.578125, 0.078125, 0.5703125, 0.2109375, 0.6484375, 0.9921875, -0.21875, 0., 0., 0.375, 0.125, -0.3515625, -0.3828125, -0.296875, 0., -0.375, 0.3203125, -0.3046875, 0., 0., 0.171875, 0., -0.25, 0., 0.1640625, -0.5, 0., 0.125, 0., -0.1484375, 0.3203125, 0.2265625, -0.6484375, -0.09375, 0., 0., 0.1640625, 0., 0., -0.109375, 0.265625, 0., 0., 0., 0.0390625, -0.28125, 0., 0.9921875, 0., -0.1875, -0.375, -0.3515625, 0.5703125, 0.625, 0., 0., 0., 0.328125, 0.2578125, -0.671875, 0., 0.328125, 0.3671875, 0., -0.1015625, -0.9921875, 0., 0.40625, -0.3828125, 0.6953125, 0., 0.4296875, -0.125, -0.2265625, 0., 0.2578125, 0., 0., 0., -0.2265625, -0.984375, 0.109375, -0.25, -0.078125, 0., 0., 0.296875, 0., 0.9921875, 0.9921875, 0., -0.3359375, 0., 0.0546875, -0.171875, 0., 0., -0.515625, 0., 0.1640625, 0.2578125, 0., -0.484375, 0., 0., 0.296875, -0.375, 0.1484375, -0.1875, -0.1484375, -0.390625, 0., 0., 0., 0.1171875, 0., 0., 0.3671875, -0.421875, -0.4921875, -0.0546875, 0., 0., 0., 0., -0.0703125, 0., 0., 0., -0.9921875, 0., 0.84375, 0.2578125, 0., 0., 0., -0.0546875, -0.109375, -0.375, 0., -0.4921875, 0., 0.5078125, 0., 0., -0.28125, 0., -0.1171875, 0., 0.1171875, 0., 0.3046875, 0.2890625, -0.8046875, -0.4765625, 0.9375, 0.4609375, -0.703125, -0.4921875, 0.9921875, -0.9921875, 0.9921875, 0.9921875, -0.5703125, -0.9921875, -0.28125, 0.9921875, -0.2109375, 0.1875, -0.1796875, 0.125, -0.9921875, -0.9921875, 0.4453125, 0.1171875, 0.359375, -0.3984375, -0.9921875, 0., 0.0546875, 0., -0.3203125, 0.3359375, -0.5703125, 0., 0., 0., 0., -0.25, 0.9921875, -0.1640625, 0., 0., -0.9921875, 0.078125, 0.390625, 0.1484375, 0.5078125, 0., 0., 0., 0., -0.90625, 0., -0.2109375, -0.0703125, 0., 0., 0.5703125, 0., 0., -0.1875, -0.1328125, 0., 0., -0.2109375, -0.1640625, -0.375, 0., 0., 0., 0., 0., -0.046875, 0., 0.0390625, 0.2734375, 0., 0., 0.9921875, 0., -0.1796875, 0., 0., 0., 0., 0., -0.3046875, 0.1171875, -0.9921875, 0.1328125, 0., -0.3515625, 0.9921875, 0.9921875, -0.234375, 0.1015625, 0., 0.9921875, 0.3203125, 0.4140625, -0.21875, 0., 0.5, 0.3515625, -0.515625, -0.9921875, -0.9921875, -0.6171875, 0.2421875, 0.796875, 0.140625, -0.7734375, 0.2109375, -0.1796875, 0.1875, -0.0703125, 0.5390625, 0.71875, -0.3359375, 0., -0.484375, 0.453125, 0.2265625, 0., 0.4609375, 0., 0., 0.3046875, -0.0859375, 0.1796875, 0.53125, 0.1953125, 0., 0.3125, 0., -0.21875, 0., 0., -0.9921875, 0., -0.1875, -0.1328125, 0.9921875, 0., 0., -0.1328125, 0., -0.8515625, 0.5625, 0.0546875, 0.3671875, 0.375, 0., 0., 0.6171875, 0., 0., 0., 0., -0.9921875, -0.9921875, 0.3125, 0., 0.9921875, -0.6640625, 0., 0., 0., 0., 0.125, -0.9921875, -0.0625, 0.40625, 0., 0.9921875, -0.3828125, 0., 0., 0., 0., -0.484375, 0., 0.3671875, 0.09375, 0.0390625, 0.4921875, 0., -0.03125};
static biases_t biases[OUTPUT_WIDTH] = {-0.1953125, 0.421875, 0.0234375, 0.0703125, 0.4453125, -0.3515625, 0.3515625, 0.328125, 0.25, 0., -0.109375, -0.0703125, 0.0625, -0.078125, 0.0390625, 0.0625, 0.234375, 0.15625, -0.1015625, 0.0390625, 0.0546875, 0.2578125, 0.28125, 0.1953125, 0.2734375, 0.3046875, -0.0625, 0.34375, 0.046875, 0.0078125, 0.1953125, -0.2578125};

using std::array;

template <typename input_t,
          typename output_t,
          typename weight_t,
          typename bias_t,
          typename accum_t,
          int F_IN,
          int F_OUT,
          int II>
void dense(hls::stream<array<input_t,F_IN>> &inputStream,
           hls::stream<array<output_t,F_OUT>> &outputStream,
           weight_t weights[F_IN * F_OUT],
           bias_t biases[F_OUT]) {
    #pragma HLS ARRAY_PARTITION variable=biases complete
    accum_t mult[F_IN * F_OUT];
    #pragma HLS ARRAY_PARTITION variable=mult complete
    accum_t acc[F_OUT];
    #pragma HLS ARRAY_PARTITION variable=acc complete

    for(int ii = 0; ii < II; ii++) {
        #pragma HLS PIPELINE II=1 style=flp rewind
        array<input_t,F_IN> input;
        inputStream >> input;

        for (int ii = 0; ii < F_IN; ii++) {
            for (int jj = 0; jj < F_OUT; jj++) {
                int index = ii * F_OUT + jj;
                mult[index] = input[ii] * weights[index];
            }
        }

        for (int iacc = 0; iacc < F_OUT; iacc++) {
            acc[iacc] = static_cast<accum_t>(biases[iacc]);
            }

        for (int ii = 0; ii < F_IN; ii++) {
            for (int jj = 0; jj < F_OUT; jj++) {
                int index = ii * F_OUT + jj;
                acc[jj] += mult[index];
            }
        }

        array<output_t,F_OUT> result;

        for (int i = 0; i < F_OUT; i++) {
            if(acc[i] > 0)
                result[i] = static_cast<output_t>(acc[i]);
            else
                result[i] = static_cast<output_t>(0.0);        
            }

        outputStream << result;
    }
}

void dut(hls::stream<array<input_relu_t, INPUT_WIDTH>> &inputStream,
         hls::stream<array<output_relu_t, OUTPUT_WIDTH>> &outputStream);

#endif